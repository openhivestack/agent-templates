import express from 'express'
import {v4 as uuidv4} from 'uuid'
import type {AgentCard, Message, MessageSendParams} from '@a2a-js/sdk'
import {A2AClient} from '@a2a-js/sdk/client'
import {
  AgentExecutor,
  RequestContext,
  ExecutionEventBus,
  DefaultRequestHandler,
  InMemoryTaskStore,
} from '@a2a-js/sdk/server'
import {A2AExpressApp} from '@a2a-js/sdk/server/express'
import {OpenHive} from '@open-hive/sdk'
import * as dotenv from 'dotenv'
import * as fs from 'fs'
import {URL} from 'url'

dotenv.config()

// Load Agent Card from .agent-card.json
const agentCard: AgentCard = JSON.parse(
  fs.readFileSync('.agent-card.json', 'utf8'),
)

// Initialize the remote registry client
const registry = new OpenHive({
  registryUrl: 'http://localhost:4001',
})

/**
 * Executor - Implements the core agent logic
 *
 * This executor receives a message, finds another agent with the 'chat' skill,
 * relays the message to it, and then returns the response.
 */
class Executor implements AgentExecutor {
  async execute(
    requestContext: RequestContext,
    eventBus: ExecutionEventBus,
  ): Promise<void> {
    const {contextId, userMessage} = requestContext
    const userText =
      userMessage?.parts?.find(p => p.kind === 'text')?.text || ''
    
    console.log(`[${contextId}] üì© Message received: "${userText}"`);

    try {
      // 1. Find a chat agent in the registry
      console.log(`[${contextId}] üîç Searching for a 'chat' agent in the registry...`);
      const searchResults = await registry.search('skill:chat')
      const chatAgent = searchResults.find(
        // Ensure we don't find and call ourselves in a loop
        agent => agent.name !== agentCard.name,
      )

      if (!chatAgent) {
        console.log(`[${contextId}] ‚ùå No other 'chat' agent found.`);
        throw new Error("No other 'chat' agent found in the local registry.")
      }

      console.log(`[${contextId}] ‚úÖ Found agent: "${chatAgent.name}" at ${chatAgent.url}`);

      // 2. Connect to the found agent
      const client = await A2AClient.fromCardUrl(
        `${chatAgent.url}/.well-known/agent-card.json`,
      )

      // 3. Relay the user's message to the other agent
      console.log(`[${contextId}] üì≤ Relaying message to "${chatAgent.name}"...`);
      const sendParams: MessageSendParams = {
        message: {
          ...userMessage,
          messageId: uuidv4(), // Generate a new ID for the relayed message
        },
      }

      const response = await client.sendMessage(sendParams)
      console.log(`[${contextId}] üì© Received response from "${chatAgent.name}".`);

      if ('error' in response) {
        throw new Error(
          `Error from relayed agent: ${response.error.message}`,
        )
      }

      // 4. Return the response from the other agent
      eventBus.publish(response.result as Message)
      console.log(`[${contextId}] üì§ Relayed response sent.`);
    } catch (error: any) {
      // Handle errors (e.g., agent not found, network issues)
      console.error(`[${contextId}] üí• Error during execution:`, error.message);
      const errorMessage: Message = {
        kind: 'message',
        messageId: uuidv4(),
        role: 'agent',
        parts: [{kind: 'text', text: `Error: ${error.message}`}],
        contextId: contextId,
      }
      eventBus.publish(errorMessage)
    } finally {
      eventBus.finished()
    }
  }

  async cancelTask(
    taskId: string,
    eventBus: ExecutionEventBus,
  ): Promise<void> {
    console.log(`[${taskId}] Task cancellation requested`)
  }
}

// Initialize A2A Server
const port = process.env.PORT
  ? parseInt(process.env.PORT, 10)
  : new URL(agentCard.url).port;
const agentExecutor = new Executor()
const taskStore = new InMemoryTaskStore()
const requestHandler = new DefaultRequestHandler(
  agentCard,
  taskStore,
  agentExecutor,
)
const appBuilder = new A2AExpressApp(requestHandler)
const app = appBuilder.setupRoutes(express())

// Start server
app.listen(port, () => {
  console.log(
    `üöÄ A2A Communicator Agent "${agentCard.name}" listening on port ${port}`,
  )
  console.log(
    `üìã Agent Card: http://localhost:${port}/.well-known/agent-card.json`,
  )
})
