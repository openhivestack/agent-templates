import asyncio
import json
import os
import uvicorn
import uuid
from urllib.parse import urlparse
from fastapi import FastAPI
from dotenv import load_dotenv

from a2a.client import A2AClient
from a2a.server.apps.jsonrpc.fastapi_app import A2AFastAPIApplication
from a2a.server.agent_execution import AgentExecutor
from a2a.server.request_handlers.default_request_handler import DefaultRequestHandler
from a2a.server.tasks.inmemory_task_store import InMemoryTaskStore
from a2a.server.agent_execution.context import RequestContext
from a2a.types import AgentCard, Message, MessageSendParams
from openhive import RemoteRegistry

# Load environment variables from .env file
load_dotenv()

# Load agent card from .agent-card.json
with open(".agent-card.json", "r") as f:
    agent_card_dict = json.load(f)

# Override URL from environment if present
if os.getenv("AGENT_URL"):
    agent_card_dict["url"] = os.getenv("AGENT_URL")

# Convert dict to AgentCard object
agent_card = AgentCard.model_validate(agent_card_dict)

# Initialize the remote registry client
registry = RemoteRegistry(base_url="http://localhost:4001")


class Executor(AgentExecutor):
    """
    Implements the core agent logic.
    This executor receives a message, finds another agent with the 'chat' skill,
    relays the message to it, and then returns the response.
    """

    async def execute(
        self, request_context: RequestContext, event_bus
    ):
        user_message = request_context.user_message
        context_id = request_context.context_id
        user_text = next(
            (p["text"] for p in user_message["parts"] if p["kind"] == "text"), ""
        )
        print(f'[{context_id}] üì© Message received: "{user_text}"')

        try:
            # 1. Find a chat agent in the registry
            print(f"[{context_id}] üîç Searching for a 'chat' agent in the registry...")
            search_results = await registry.search("skill:chat")
            # Ensure we don't find and call ourselves in a loop
            chat_agent = next(
                (
                    agent
                    for agent in search_results
                    if agent["name"] != agent_card.name
                ),
                None,
            )

            if not chat_agent:
                print(f"[{context_id}] ‚ùå No other 'chat' agent found.")
                raise Exception("No other 'chat' agent found in the local registry.")

            print(f"[{context_id}] ‚úÖ Found agent: \"{chat_agent['name']}\" at {chat_agent['url']}")

            # 2. Connect to the found agent
            card_url = f"{chat_agent['url']}/.well-known/agent-card.json"
            client = await A2AClient.from_card_url(card_url)

            # 3. Relay the user's message to the other agent
            print(f"[{context_id}] üì≤ Relaying message to \"{chat_agent['name']}\"...")
            send_params: MessageSendParams = {
                "message": {
                    **user_message,
                    "messageId": str(uuid.uuid4()),  # Generate a new ID
                }
            }
            response = await client.send_message(send_params)
            print(f"[{context_id}] üì© Received response from \"{chat_agent['name']}\".")

            if "error" in response:
                raise Exception(f"Error from relayed agent: {response['error']['message']}")

            # 4. Return the response from the other agent
            event_bus.publish(response["result"])
            print(f"[{context_id}] üì§ Relayed response sent.")

        except Exception as e:
            # Handle errors (e.g., agent not found, network issues)
            print(f"[{context_id}] üí• Error during execution: {e}")
            error_message: Message = {
                "kind": "message",
                "messageId": str(uuid.uuid4()),
                "role": "agent",
                "parts": [{"kind": "text", "text": f"Error: {e}"}],
                "contextId": context_id,
            }
            event_bus.publish(error_message)
        finally:
            event_bus.finished()

    async def cancel(self, task_id: str, event_bus):
        print(f"[{task_id}] Task cancellation requested")


# Initialize A2A Server
app = FastAPI()
agent_executor = Executor()
task_store = InMemoryTaskStore()
request_handler = DefaultRequestHandler(
    task_store=task_store, agent_executor=agent_executor
)
app_builder = A2AFastAPIApplication(agent_card=agent_card, http_handler=request_handler)
app_builder.add_routes_to_app(app, agent_card_url=str(".agent-card.json"))

if __name__ == "__main__":
    port_str = os.environ.get("PORT")
    if port_str:
        port = int(port_str)
    else:
        parsed_url = urlparse(agent_card.url)
        port = parsed_url.port or 8082
    print(
        f"üöÄ A2A Communicator Agent \"{agent_card.name}\" listening on port {port}"
    )
    print(
        f"üìã Agent Card: http://localhost:{port}/.well-known/agent-card.json"
    )
    uvicorn.run(app, host="0.0.0.0", port=port)
